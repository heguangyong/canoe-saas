(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["pagesSys-site-WebService"],{"0a0c":function(t,a,e){"use strict";e.r(a);var r=e("94fc"),n=e("4076");for(var s in n)"default"!==s&&function(t){e.d(a,t,(function(){return n[t]}))}(s);e("d70e");var o,c=e("f0c5"),u=Object(c["a"])(n["default"],r["b"],r["c"],!1,null,"6a28cc23",null,!1,r["a"],o);a["default"]=u.exports},"0b23":function(t,a,e){var r=e("8630");"string"===typeof r&&(r=[[t.i,r,""]]),r.locals&&(t.exports=r.locals);var n=e("4f06").default;n("c5dcd466",r,!0,{sourceMap:!1,shadowMode:!1})},4076:function(t,a,e){"use strict";e.r(a);var r=e("4c94"),n=e.n(r);for(var s in r)"default"!==s&&function(t){e.d(a,t,(function(){return r[t]}))}(s);a["default"]=n.a},"4c94":function(t,a,e){"use strict";var r=e("4ea4");e("26e9"),Object.defineProperty(a,"__esModule",{value:!0}),a.default=void 0,e("96cf");var n=r(e("1da1")),s=r(e("5530")),o=e("2f62"),c=r(e("d3b3")),u={data:function(){return{sourceCardId:"",targetCardId:"",talkWatch:null,roomId:"",chatRoom:{},content:"",source:{},target:{},talk:[],historyTalk:[],hasHistory:!0,lastHistory:{_id:0,content:"",send_time:""},page:1,timer:null}},onLoad:function(t){var a=this;a.sourceCardId=a.user.userInfo.cardId,t.sourceCardId&&(a.sourceCardId=t.sourceCardId),a.targetCardId=a.user.userInfo.bizCardId,t.targetCardId&&(a.targetCardId=t.targetCardId)},mounted:function(){this.timer=setInterval(this.loadNewMsgList,6e3)},beforeDestroy:function(){clearInterval(this.timer)},onShow:function(){this.watchChatRoom()},onHide:function(){var t=this;this.talkWatch&&this.talkWatch.close().then((function(){t.talkWatch=null}))},onPageScroll:function(t){t.scrollTop<5&&this.hasHistory&&(this.page++,this.loadHistory())},computed:(0,s.default)({},(0,o.mapState)(["user"])),methods:{watchChatRoom:function(){var t=this;return(0,n.default)(regeneratorRuntime.mark((function a(){var e,r,n,s,o,u;return regeneratorRuntime.wrap((function(a){while(1)switch(a.prev=a.next){case 0:return e=t,r={},n={},s=null,a.next=6,c.default.callFunction({name:"web",data:{$url:"getCardDetailById",id:e.sourceCardId}});case 6:return s=a.sent,r=JSON.parse(s.result.data),a.next=10,c.default.callFunction({name:"web",data:{$url:"getCardDetailById",id:e.targetCardId}});case 10:return s=a.sent,n=JSON.parse(s.result.data),a.next=14,c.default.callFunction({name:"web",data:{$url:"getChatRoom",sourceId:e.sourceCardId,targetId:e.targetCardId}});case 14:if(s=a.sent,-1!=s.result.code){a.next=25;break}return e.chatRoom={target_id:n._id,target_name:n.name,target_avatar:n.avatar,source_id:r._id,source_name:r.name,source_avatar:r.avatar,content:[],target_unread:0,source_unread:0,last_history:""},o=null,a.next=20,c.default.callFunction({name:"sys",data:{$url:"addChatRoom",chatRoom:e.chatRoom}});case 20:o=a.sent,e.roomId=o.result.data,e.chatRoom._id=e.roomId,a.next=26;break;case 25:0==s.result.code&&(e.chatRoom=JSON.parse(s.result.data),e.roomId=e.chatRoom._id);case 26:return a.next=28,c.default.callFunction({name:"sys",data:{$url:"exchangeCards",roomId:e.roomId,askCardId:e.sourceCardId,answerCardId:e.targetCardId}});case 28:return s=a.sent,u=e.chatRoom.source_id==e.sourceCardId,e.source.sourceId=u?e.chatRoom.source_id:e.chatRoom.target_id,e.source.sourceName=u?e.chatRoom.source_name:e.chatRoom.target_name,e.source.sourceAvatar=u?e.chatRoom.source_avatar:e.chatRoom.target_avatar,e.target.targetId=u?e.chatRoom.target_id:e.chatRoom.source_id,e.target.targetName=u?e.chatRoom.target_name:e.chatRoom.source_name,e.target.targetAvatar=u?e.chatRoom.target_avatar:e.chatRoom.source_avatar,a.next=38,c.default.callFunction({name:"sys",data:{$url:"clearUnreadChatTip",id:e.roomId,isSource:u}});case 38:e.loadHistory(),e.historyTalk=e.historyTalk.reverse(),uni.pageScrollTo({scrollTop:9999999,duration:0});case 41:case"end":return a.stop()}}),a)})))()},loadHistory:function(){var t=this;return(0,n.default)(regeneratorRuntime.mark((function a(){var e,r,n,s;return regeneratorRuntime.wrap((function(a){while(1)switch(a.prev=a.next){case 0:return e=t,a.next=3,c.default.callFunction({name:"web",data:{$url:"getChatMsgHistoryList",id:e.roomId,page:e.page}});case 3:if(r=a.sent,0==r.result.code)for(n=null,n=JSON.parse(r.result.data),s=0;s<n.length;s++)e.historyTalk.unshift(n[s]);else e.hasHistory=!1;case 5:case"end":return a.stop()}}),a)})))()},loadNewMsgList:function(){var t=this;return(0,n.default)(regeneratorRuntime.mark((function a(){var e,r,n;return regeneratorRuntime.wrap((function(a){while(1)switch(a.prev=a.next){case 0:return e=t,e.lastHistory=e.historyTalk[e.historyTalk.length-1]||{_id:0,content:"",send_time:""},a.next=4,c.default.callFunction({name:"web",data:{$url:"getNewChatMsgList",id:e.roomId,create_at:e.lastHistory.create_at}});case 4:r=a.sent,0==r.result.code&&(n=JSON.parse(r.result.data),Object.assign(e.talk,n),uni.pageScrollTo({scrollTop:9999999,duration:0}),e.$forceUpdate());case 6:case"end":return a.stop()}}),a)})))()},inputContent:function(t){this.content=t.detail.value},send:function(){var t=this;return(0,n.default)(regeneratorRuntime.mark((function a(){var e,r,n,s,o;return regeneratorRuntime.wrap((function(a){while(1)switch(a.prev=a.next){case 0:if(e=t,""==e.content){a.next=20;break}return r={},r={content:t.content,source:e.source.sourceId,target:e.target.targetId,type:"text",room_id:e.roomId},n=null,a.next=7,c.default.callFunction({name:"sys",data:{$url:"addTalk",talk:r}});case 7:if(n=a.sent,0!=n.result.code){a.next=17;break}return s="",o=!1,s=t.content,o=e.chatRoom.source_id==e.sourceCardId,null,a.next=16,c.default.callFunction({name:"sys",data:{$url:"updateChatRoomUnreadTip",id:e.roomId,tid:n.result.data,last_history:s,isSource:o}});case 16:a.sent;case 17:e.content="",uni.pageScrollTo({scrollTop:999999,duration:0}),t.$forceUpdate();case 20:case"end":return a.stop()}}),a)})))()},getDateDiff:function(t){var a="",e=Date.parse(new Date),r=Math.abs(e-t);if(r>6048e5){a=new Date(t);var n=a.getFullYear(),s=a.getMonth()+1,o=a.getDate(),c=(new Date).getFullYear();a=c==n?s+"月"+o+"日":n+"年"+s+"月"+o+"日"}else if(r<6048e5&&r>864e5){var u=Math.floor(r/864e5);a=u+"天前"}else if(r<864e5&&r>36e5){u=Math.floor(r/36e5);a=u+"小时前"}else r<36e5&&r>=0&&(a="");return a}}};a.default=u},8630:function(t,a,e){var r=e("24fb");a=r(!1),a.push([t.i,".box[data-v-6a28cc23]{margin:%?20?% 0}.box uni-view.cu-bar[data-v-6a28cc23]{margin-top:%?20?%}",""]),t.exports=a},"94fc":function(t,a,e){"use strict";var r;e.d(a,"b",(function(){return n})),e.d(a,"c",(function(){return s})),e.d(a,"a",(function(){return r}));var n=function(){var t=this,a=t.$createElement,e=t._self._c||a;return e("v-uni-view",[e("cu-custom",{attrs:{isBack:!0}},[e("template",{attrs:{slot:"backText"},slot:"backText"},[t._v("返回")]),e("template",{attrs:{slot:"content"},slot:"content"},[t._v(t._s(t.target.targetName))])],2),t._l(t.historyTalk,(function(a){return e("v-uni-view",{key:a._id,staticClass:"cu-chat"},[e("v-uni-view",{staticClass:"cu-item",class:a.source==t.sourceCardId?"self":""},[a.source!=t.sourceCardId?e("v-uni-image",{staticClass:"cu-avatar round",attrs:{src:t.target.targetAvatar}}):t._e(),e("v-uni-view",{staticClass:"main"},[e("v-uni-view",{staticClass:"content shadow",class:a.source==t.sourceCardId?"bg-grey.light":""},[e("v-uni-text",[t._v(t._s(a.content))])],1)],1),a.source==t.sourceCardId?e("v-uni-image",{staticClass:"cu-avatar round",attrs:{src:t.source.sourceAvatar}}):t._e(),e("v-uni-view",{staticClass:"date"},[t._v(t._s(t.getDateDiff(a.create_at)))])],1)],1)})),t._l(t.talk,(function(a){return e("v-uni-view",{key:a._id,staticClass:"cu-chat"},[e("v-uni-view",{staticClass:"cu-item",class:a.source==t.sourceCardId?"self":""},[a.source!=t.sourceCardId?e("v-uni-image",{staticClass:"cu-avatar round",attrs:{src:t.target.targetAvatar}}):t._e(),e("v-uni-view",{staticClass:"main"},[e("v-uni-view",{staticClass:"content shadow",class:a.source==t.sourceCardId?"bg-grey.light":""},[e("v-uni-text",[t._v(t._s(a.content))])],1)],1),a.source==t.sourceCardId?e("v-uni-image",{staticClass:"cu-avatar round",attrs:{src:t.source.sourceAvatar}}):t._e(),e("v-uni-view",{staticClass:"date"},[t._v(t._s(t.getDateDiff(a.create_at)))])],1)],1)})),e("v-uni-view",{staticClass:"cu-tabbar-height"}),e("v-uni-view",{staticClass:"cu-bar foot input"},[e("v-uni-view",[e("v-uni-image",{staticClass:"cu-avatar round",attrs:{mode:"aspectFill",src:t.source.sourceAvatar}})],1),e("v-uni-input",{staticClass:"solid-bottom",attrs:{value:t.content,maxlength:"300","cursor-spacing":"10"},on:{input:function(a){arguments[0]=a=t.$handleEvent(a),t.inputContent.apply(void 0,arguments)}}}),e("v-uni-button",{staticClass:"cu-btn line-grey shadow-blur",on:{click:function(a){arguments[0]=a=t.$handleEvent(a),t.send.apply(void 0,arguments)}}},[t._v("发送")])],1)],2)},s=[]},d70e:function(t,a,e){"use strict";var r=e("0b23"),n=e.n(r);n.a}}]);