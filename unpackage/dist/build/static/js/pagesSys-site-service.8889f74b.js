(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["pagesSys-site-service"],{"11d2":function(t,a,e){"use strict";var r=e("b028"),o=e.n(r);o.a},"129a":function(t,a,e){"use strict";(function(t){var r=e("4ea4");e("26e9"),Object.defineProperty(a,"__esModule",{value:!0}),a.default=void 0,e("96cf");var o=r(e("1da1")),s=r(e("5530")),n=e("2f62"),c={data:function(){return{sourceCardId:"",targetCardId:"",talkWatch:null,roomId:"",chatRoom:{},content:"",source:{},target:{},talk:[],historyTalk:[],hasHistory:!0,page:1}},onLoad:function(t){var a=this;a.sourceCardId=a.user.userInfo.cardId,t.sourceCardId&&(a.sourceCardId=t.sourceCardId),a.targetCardId=a.user.userInfo.bizCardId,t.targetCardId&&(a.targetCardId=t.targetCardId)},onShow:function(){this.watchChatRoom()},onHide:function(){var t=this;this.talkWatch&&this.talkWatch.close().then((function(){t.talkWatch=null}))},onPageScroll:function(t){t.scrollTop<5&&this.hasHistory&&(this.page++,this.loadHistory())},computed:(0,s.default)({},(0,n.mapState)(["user"])),methods:{watchChatRoom:function(){var a=this;return(0,o.default)(regeneratorRuntime.mark((function e(){var r,o,s,n,c,u,i;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return r=a,e.next=3,wx.cloud.callFunction({name:"sys",data:{$url:"getCardDetailById",id:r.sourceCardId}});case 3:return o=e.sent,s=o.result.data,e.next=7,wx.cloud.callFunction({name:"sys",data:{$url:"getCardDetailById",id:r.targetCardId}});case 7:return o=e.sent,n=o.result.data,e.next=11,wx.cloud.callFunction({name:"sys",data:{$url:"getChatRoom",sourceId:r.sourceCardId,targetId:r.targetCardId}});case 11:if(o=e.sent,-1!=o.result.code){e.next=21;break}return r.chatRoom={target_id:n._id,target_name:n.name,target_avatar:n.avatar,source_id:s._id,source_name:s.name,source_avatar:s.avatar,content:[],target_unread:0,source_unread:0,last_history:""},e.next=16,wx.cloud.callFunction({name:"sys",data:{$url:"addChatRoom",chatRoom:r.chatRoom}});case 16:c=e.sent,r.roomId=c.result.data,r.chatRoom._id=r.roomId,e.next=22;break;case 21:0==o.result.code&&(r.chatRoom=o.result.data,r.roomId=r.chatRoom._id);case 22:return e.next=24,wx.cloud.callFunction({name:"sys",data:{$url:"exchangeCards",roomId:r.roomId,askCardId:r.sourceCardId,answerCardId:r.targetCardId}});case 24:return o=e.sent,t("log","交换名片",o," at pagesSys/site/service.vue:166"),u=r.chatRoom.source_id==r.sourceCardId,r.source.sourceId=u?r.chatRoom.source_id:r.chatRoom.target_id,r.source.sourceName=u?r.chatRoom.source_name:r.chatRoom.target_name,r.source.sourceAvatar=u?r.chatRoom.source_avatar:r.chatRoom.target_avatar,r.target.targetId=u?r.chatRoom.target_id:r.chatRoom.source_id,r.target.targetName=u?r.chatRoom.target_name:r.chatRoom.source_name,r.target.targetAvatar=u?r.chatRoom.target_avatar:r.chatRoom.source_avatar,t("log","加载聊天室：","roomId",r.roomId,"sourceName",r.source.sourceName,"targetName",r.target.targetName,"isSource",u," at pagesSys/site/service.vue:175"),e.next=36,wx.cloud.callFunction({name:"sys",data:{$url:"clearUnreadChatTip",id:r.roomId,isSource:u}});case 36:i=wx.cloud.database(),r.talkWatch=i.collection("sys_chat_msg").where({room_id:r.roomId}).watch({onChange:function(t){"init"===t.type?wx.cloud.callFunction({name:"sys",data:{$url:"getChatMsgHistoryList",id:r.roomId,page:r.page}}).then((function(t){r.historyTalk=t.result.data,r.historyTalk=r.historyTalk.reverse(),uni.pageScrollTo({scrollTop:9999999,duration:0})})):"add"==t.docChanges[0].dataType&&(r.talk.push(t.docChanges[0].doc),uni.pageScrollTo({scrollTop:9999999,duration:0}))},onError:function(a){t("log","the watch closed because of error",a," at pagesSys/site/service.vue:218")}});case 38:case"end":return e.stop()}}),e)})))()},loadHistory:function(){var t=this;return(0,o.default)(regeneratorRuntime.mark((function a(){var e,r,o,s;return regeneratorRuntime.wrap((function(a){while(1)switch(a.prev=a.next){case 0:return e=t,a.next=3,wx.cloud.callFunction({name:"sys",data:{$url:"getChatMsgHistoryList",id:e.roomId,page:e.page}});case 3:if(r=a.sent,0==r.result.code)for(o=r.result.data,s=0;s<o.length;s++)e.historyTalk.unshift(o[s]);else e.hasHistory=!1;case 5:case"end":return a.stop()}}),a)})))()},inputContent:function(t){this.content=t.detail.value},send:function(){var t=this;return(0,o.default)(regeneratorRuntime.mark((function a(){var e,r,o,s,n,c;return regeneratorRuntime.wrap((function(a){while(1)switch(a.prev=a.next){case 0:if(e=t,""==e.content){a.next=24;break}return a.next=4,wx.cloud.callFunction({name:"sys",data:{$url:"msgSecCheck",value:e.content}});case 4:if(r=a.sent,0==r.result.code){a.next=8;break}return uni.showToast({icon:"none",title:"内容含有违规内容，请修改后提交"}),a.abrupt("return");case 8:return o={},o={content:t.content,source:e.source.sourceId,target:e.target.targetId,type:"text",room_id:e.roomId},a.next=12,wx.cloud.callFunction({name:"sys",data:{$url:"addTalk",talk:o}});case 12:if(s=a.sent,0!=s.result.code){a.next=21;break}return n="",c=!1,n=t.content,c=e.chatRoom.source_id==e.sourceCardId,a.next=20,wx.cloud.callFunction({name:"sys",data:{$url:"updateChatRoomUnreadTip",id:e.roomId,tid:s.result.data,last_history:n,isSource:c}});case 20:a.sent;case 21:e.content="",uni.pageScrollTo({scrollTop:9999999,duration:0}),t.$forceUpdate();case 24:case"end":return a.stop()}}),a)})))()},getDateDiff:function(t){var a="",e=Date.parse(new Date),r=Math.abs(e-t);if(r>6048e5){a=new Date(t);var o=a.getFullYear(),s=a.getMonth()+1,n=a.getDate(),c=(new Date).getFullYear();a=c==o?s+"月"+n+"日":o+"年"+s+"月"+n+"日"}else if(r<6048e5&&r>864e5){var u=Math.floor(r/864e5);a=u+"天前"}else if(r<864e5&&r>36e5){u=Math.floor(r/36e5);a=u+"小时前"}else r<36e5&&r>=0&&(a="");return a}}};a.default=c}).call(this,e("0de9")["log"])},"4a36":function(t,a,e){var r=e("24fb");a=r(!1),a.push([t.i,".box[data-v-7ccff03d]{margin:%?20?% 0}.box uni-view.cu-bar[data-v-7ccff03d]{margin-top:%?20?%}",""]),t.exports=a},"69d1":function(t,a,e){"use strict";var r;e.d(a,"b",(function(){return o})),e.d(a,"c",(function(){return s})),e.d(a,"a",(function(){return r}));var o=function(){var t=this,a=t.$createElement,e=t._self._c||a;return e("v-uni-view",[e("cu-custom",{attrs:{isBack:!0}},[e("template",{attrs:{slot:"backText"},slot:"backText"},[t._v("返回")]),e("template",{attrs:{slot:"content"},slot:"content"},[t._v(t._s(t.target.targetName))])],2),t._l(t.historyTalk,(function(a,r){return e("v-uni-view",{key:r,staticClass:"cu-chat"},[e("v-uni-view",{staticClass:"cu-item",class:a.source==t.sourceCardId?"self":""},[a.source!=t.sourceCardId?e("v-uni-image",{staticClass:"cu-avatar round",attrs:{mode:"aspectFill",src:t.target.targetAvatar}}):t._e(),e("v-uni-view",{staticClass:"main"},[e("v-uni-view",{staticClass:"content shadow",class:a.source==t.sourceCardId?"bg-grey.light":""},[e("v-uni-text",[t._v(t._s(a.content))])],1)],1),a.source==t.sourceCardId?e("v-uni-image",{staticClass:"cu-avatar round",attrs:{mode:"aspectFill",src:t.source.sourceAvatar}}):t._e(),e("v-uni-view",{staticClass:"date"},[t._v(t._s(t.getDateDiff(a.create_at)))])],1)],1)})),t._l(t.talk,(function(a,r){return e("v-uni-view",{key:r,staticClass:"cu-chat"},[e("v-uni-view",{staticClass:"cu-item",class:a.source==t.sourceCardId?"self":""},[a.source!=t.sourceCardId?e("v-uni-image",{staticClass:"cu-avatar round",attrs:{mode:"aspectFill",src:t.target.targetAvatar}}):t._e(),e("v-uni-view",{staticClass:"main"},[e("v-uni-view",{staticClass:"content shadow",class:a.source==t.sourceCardId?"bg-grey.light":""},[e("v-uni-text",[t._v(t._s(a.content))])],1)],1),a.source==t.sourceCardId?e("v-uni-image",{staticClass:"cu-avatar round",attrs:{mode:"aspectFill",src:t.source.sourceAvatar}}):t._e(),e("v-uni-view",{staticClass:"date"},[t._v(t._s(t.getDateDiff(a.create_at)))])],1)],1)})),e("v-uni-view",{staticClass:"cu-tabbar-height"}),e("v-uni-view",{staticClass:"cu-bar foot input"},[e("v-uni-view",[e("v-uni-image",{staticClass:"cu-avatar round",attrs:{mode:"aspectFill",src:t.source.sourceAvatar}})],1),e("v-uni-input",{staticClass:"solid-bottom",attrs:{value:t.content,maxlength:"300","cursor-spacing":"10"},on:{input:function(a){arguments[0]=a=t.$handleEvent(a),t.inputContent.apply(void 0,arguments)}}}),e("v-uni-button",{staticClass:"cu-btn line-grey shadow-blur",on:{click:function(a){arguments[0]=a=t.$handleEvent(a),t.send.apply(void 0,arguments)}}},[t._v("发送")])],1)],2)},s=[]},a239:function(t,a,e){"use strict";e.r(a);var r=e("69d1"),o=e("a93c");for(var s in o)"default"!==s&&function(t){e.d(a,t,(function(){return o[t]}))}(s);e("11d2");var n,c=e("f0c5"),u=Object(c["a"])(o["default"],r["b"],r["c"],!1,null,"7ccff03d",null,!1,r["a"],n);a["default"]=u.exports},a93c:function(t,a,e){"use strict";e.r(a);var r=e("129a"),o=e.n(r);for(var s in r)"default"!==s&&function(t){e.d(a,t,(function(){return r[t]}))}(s);a["default"]=o.a},b028:function(t,a,e){var r=e("4a36");"string"===typeof r&&(r=[[t.i,r,""]]),r.locals&&(t.exports=r.locals);var o=e("4f06").default;o("645621db",r,!0,{sourceMap:!1,shadowMode:!1})}}]);