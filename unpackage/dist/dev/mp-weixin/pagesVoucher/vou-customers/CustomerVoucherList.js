(global["webpackJsonp"]=global["webpackJsonp"]||[]).push([["pagesVoucher/vou-customers/CustomerVoucherList"],{710:function(e,t,r){"use strict";(function(e){r(5);n(r(4));var t=n(r(711));function n(e){return e&&e.__esModule?e:{default:e}}wx.__webpack_require_UNI_MP_PLUGIN__=r,e(t.default)}).call(this,r(1)["createPage"])},711:function(e,t,r){"use strict";r.r(t);var n=r(712),o=r(714);for(var u in o)"default"!==u&&function(e){r.d(t,e,(function(){return o[e]}))}(u);r(716);var a,s=r(15),i=Object(s["default"])(o["default"],n["render"],n["staticRenderFns"],!1,null,null,null,!1,n["components"],a);i.options.__file="pagesVoucher/vou-customers/CustomerVoucherList.vue",t["default"]=i.exports},712:function(e,t,r){"use strict";r.r(t);var n=r(713);r.d(t,"render",(function(){return n["render"]})),r.d(t,"staticRenderFns",(function(){return n["staticRenderFns"]})),r.d(t,"recyclableRender",(function(){return n["recyclableRender"]})),r.d(t,"components",(function(){return n["components"]}))},713:function(e,t,r){"use strict";var n;r.r(t),r.d(t,"render",(function(){return o})),r.d(t,"staticRenderFns",(function(){return a})),r.d(t,"recyclableRender",(function(){return u})),r.d(t,"components",(function(){return n}));try{n={uniPopup:function(){return r.e("components/uni-popup/uni-popup").then(r.bind(null,810))}}}catch(s){if(-1===s.message.indexOf("Cannot find module")||-1===s.message.indexOf(".vue"))throw s;console.error(s.message),console.error("1. 排查组件名称拼写是否正确"),console.error("2. 排查组件是否符合 easycom 规范，文档：https://uniapp.dcloud.net.cn/collocation/pages?id=easycom"),console.error("3. 若组件不符合 easycom 规范，需手动引入，并在 components 中注册该组件")}var o=function(){var e=this,t=e.$createElement,r=(e._self._c,0==e.tabCur&&e.isParkingWriteOff?e.formatCarNum(e.parkingCarNum):null),n=0==e.tabCur?e.__map(e.toBeUsedVouchers,(function(t,r){var n=e.__get_orig(t),o=e.formatCreateAt(t.create_at);return{$orig:n,m1:o}})):null,o=1==e.tabCur?e.__map(e.usedVouchers,(function(t,r){var n=e.__get_orig(t),o=e.formatCarNum(t.write_off_item),u=e.formatCreateAt(t.create_at);return{$orig:n,m2:o,m3:u}})):null,u=2==e.tabCur?e.__map(e.expiredVouchers,(function(t,r){var n=e.__get_orig(t),o=e.formatCreateAt(t.create_at);return{$orig:n,m4:o}})):null;e.$mp.data=Object.assign({},{$root:{m0:r,l0:n,l1:o,l2:u}})},u=!1,a=[];o._withStripped=!0},714:function(e,t,r){"use strict";r.r(t);var n=r(715),o=r.n(n);for(var u in n)"default"!==u&&function(e){r.d(t,e,(function(){return n[e]}))}(u);t["default"]=o.a},715:function(e,t,r){"use strict";(function(e){Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var n=a(r(9)),o=r(12),u=a(r(39));function a(e){return e&&e.__esModule?e:{default:e}}function s(e,t,r,n,o,u,a){try{var s=e[u](a),i=s.value}catch(c){return void r(c)}s.done?t(i):Promise.resolve(i).then(n,o)}function i(e){return function(){var t=this,r=arguments;return new Promise((function(n,o){var u=e.apply(t,r);function a(e){s(u,n,o,a,i,"next",e)}function i(e){s(u,n,o,a,i,"throw",e)}a(void 0)}))}}function c(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function l(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?c(Object(r),!0).forEach((function(t){d(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):c(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function d(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}var f={components:{},data:function(){return{isLoad:!1,title:"",customerId:"",cardId:"",tabCur:0,tab:["待使用","已使用","已无效"],toBeUsedVouchers:[],usedVouchers:[],expiredVouchers:[],page:1,isEndPage:!1,loadingType:1,isUps:!1,selectedVoucherId:"-1",isParkingWriteOff:!1,parkingCarNum:"",parkingWriteOffValue:0,entryCode:"",leftVouchers:[],writeOffVouchers:[],endVouchers:[],modalName:null,entryNumber:""}},onLoad:function(t){var r=this;if(console.log("options",t),r.title="我",t.id?r.customerId=t.id:r.customerId=r.user._id,t.cardId&&(r.cardId=t.cardId),t.title)r.title=t.title;else if(t.scene){var n={},o=decodeURIComponent(t.scene).split("&");o.forEach((function(e){var t=e.split("=");n[t[0]]=t[1]})),n.number&&(r.entryNumber=n.number,r.isParkingWriteOff=!0,wx.cloud.callFunction({name:"vou",data:{$url:"getEntryDetailByNumber",number:r.entryNumber}}).then((function(t){console.log("getDetailByNumber",t.result);var n=t.result;if(0==n.code){var o=t.result.data;console.log("entry",o),r.cardId=o.card_id,wx.cloud.callFunction({name:"sys",data:{$url:"getCardHolderByCardId",cardId:r.cardId}}).then((function(t){if(n=t.result,0==n.code&&n.data){var u=n.data.cards||{};for(var a in u)for(var s in u[a]){var i=u[a][s].role||"";i.indexOf("writeOff")>-1&&u[a][s].user_id==r.user._id&&e.navigateTo({url:"/pagesVoucher/vou-entries/WriteOffList?entryId="+o._id+"&entryName="+o.name})}}}))}})))}else t.isParkingWriteOff&&(r.isParkingWriteOff=t.isParkingWriteOff);r.tabCur=0,r.parkingCarNum=r.user.car_num||""},onShow:function(){if(!this.hasLogin)return this.setCache({VOUCHER_ENTRY_NUMBER:this.entryNumber}),this.setCache({PARK_WRITE_OFF:!0}),void e.navigateTo({url:"/pages/my/home"});this.cache["PARK_WRITE_OFF"]&&(this.isParkingWriteOff=!0,this.entryNumber=this.cache["VOUCHER_ENTRY_NUMBER"],this.setCache({PARK_WRITE_OFF:!1})),0==this.tabCur&&this.getList("TO_BE_USE")},onPullDownRefresh:function(){this.page=1,0===this.tabCur?this.getList("TO_BE_USE"):1===this.tabCur?this.getList("USED"):2===this.tabCur&&this.getList("EXPIRED"),e.stopPullDownRefresh()},onReachBottom:function(){this.page++,0===this.tabCur?this.getList("TO_BE_USE"):1===this.tabCur?this.getList("USED"):2===this.tabCur&&this.getList("EXPIRED")},computed:l(l({},(0,o.mapState)(["isLogin","user","cache"])),{},{formatCreateAt:function(){return function(e){var t=e;return t?u.default.formatTime(t,"yyyy-MM-dd HH:mm:ss"):""}},formatCarNum:function(){return function(e){var t=e||"";return t.indexOf("·")>0?t:t.length>0?t.substr(0,2)+"·"+t.substr(2):void 0}}}),methods:l(l({},(0,o.mapMutations)(["updateUser","setCache"])),{},{tabSelect:function(e){this.tabCur=e.currentTarget.dataset.id,0===this.tabCur?this.getList("TO_BE_USE"):1===this.tabCur?this.getList("USED"):2===this.tabCur&&this.getList("EXPIRED")},getList:function(e){var t=this;return i(n.default.mark((function r(){var o,u,a;return n.default.wrap((function(r){while(1)switch(r.prev=r.next){case 0:return o=t,t.isLoad=!0,o.loadingType=1,console.log(e,"customerId",o.customerId||o.user._id,"cardId",o.cardId||null),r.next=6,wx.cloud.callFunction({name:"vou",data:{$url:"getVoucherList",userId:o.customerId,cardId:o.cardId||null,page:o.page,pageSize:10,status:e}});case 6:u=r.sent,console.log("getList",e,u.result),a=u.result,0==a.code&&(1==o.page&&(o.isEndPage=!1,0===o.tabCur?o.toBeUsedVouchers=[]:1===o.tabCur?o.usedVouchers=[]:2===o.tabCur&&(o.expiredVouchers=[])),a.data.forEach((function(e){0===o.tabCur?o.toBeUsedVouchers.push(e):1===o.tabCur?o.usedVouchers.push(e):2===o.tabCur&&o.expiredVouchers.push(e)}))),a.data.length<10&&(o.isEndPage=!0,o.loadingType=2),o.isLoad=!1;case 12:case"end":return r.stop()}}),r)})))()},goDetail:function(t){console.log("activity detail",t.activity_id,t),e.navigateTo({url:"/pagesVoucher/vou-customers/VoucherDetail?id="+t._id})},removeVoucher:function(){var t=this;return i(n.default.mark((function r(){var o;return n.default.wrap((function(r){while(1)switch(r.prev=r.next){case 0:return o=t,console.log("go remove voucher",o.selectedVoucherId),r.next=4,wx.cloud.callFunction({name:"vou",data:{$url:"removeVoucher",cardId:o.selectedVoucherId}});case 4:e.showToast({icon:"success",title:"删除成功"}),o.getSearchList("refresh"),o.$refs["showPopupOperate"].close(),o.$forceUpdate();case 8:case"end":return r.stop()}}),r)})))()},goHome:function(){e.reLaunch({url:"/pages/my/home"})},checkCarNum:function(t){var r=/^[京津沪渝冀豫云辽黑湘皖鲁新苏浙赣鄂桂甘晋蒙陕吉闽贵粤青藏川宁琼使领A-Z]{1}[A-Z]{1}(([0-9]{5}[DF]$)|([DF][A-HJ-NP-Z0-9][0-9]{4}$))/,n=/^[京津沪渝冀豫云辽黑湘皖鲁新苏浙赣鄂桂甘晋蒙陕吉闽贵粤青藏川宁琼使领A-Z]{1}[A-Z]{1}[A-HJ-NP-Z0-9]{4}[A-HJ-NP-Z0-9挂学警港澳]{1}$/;return 7==t.length?n.test(t):8==t.length?r.test(t):(e.showToast({title:"请输入正确的车牌号码！",icon:"none"}),!1)},doWriteOff:function(){var t=this;return i(n.default.mark((function r(){var o,u,a,s,i,c,l,d,f,h,p,m,g,b,_;return n.default.wrap((function(r){while(1)switch(r.prev=r.next){case 0:if(o=t,o.parkingCarNum=o.parkingCarNum.toUpperCase(),console.log(o.parkingCarNum),0!=o.parkingCarNum.length){r.next=6;break}return e.showToast({icon:"none",title:"请输入车牌号"}),r.abrupt("return");case 6:if(o.parkingCarNum.indexOf("·")>0&&(u=o.parkingCarNum.indexOf("·"),o.parkingCarNum=o.parkingCarNum.substr(0,u)+o.parkingCarNum.substr(u+1),console.log("carNum",u,o.parkingCarNum)),o.checkCarNum(o.parkingCarNum)){r.next=10;break}return console.log("车牌检测",o.parkingCarNum),r.abrupt("return");case 10:if(a=/^[0-9]*$/,console.log("只能输入数字",a.test(o.parkingWriteOffValue)),a.test(o.parkingWriteOffValue)){r.next=15;break}return e.showToast({icon:"none",title:"只能输入数字"}),r.abrupt("return");case 15:if(0!=o.parkingWriteOffValue){r.next=18;break}return e.showToast({icon:"none",title:"消费金额不能为零"}),r.abrupt("return");case 18:if(0!=o.toBeUsedVouchers.length){r.next=21;break}return e.showToast({icon:"none",title:"没有可用券"}),r.abrupt("return");case 21:return o.isLoad=!0,o.user.car_num=o.parkingCarNum,o.updateUser(o.user),r.next=26,wx.cloud.callFunction({name:"sys",data:{$url:"updateUserInfo",id:o.user._id,userInfo:o.user.userInfo}});case 26:s=!1,i=o.parkingWriteOffValue,c=[],l="",o.leftVouchers=[],o.writeOffVouchers=[],o.endVouchers=[],r.t0=n.default.keys(o.toBeUsedVouchers);case 34:if((r.t1=r.t0()).done){r.next=48;break}if(d=r.t1.value,!(i>=o.toBeUsedVouchers[d].price)){r.next=46;break}if(f=o.toBeUsedVouchers[d].price,h=parseInt(i/f),p=o.toBeUsedVouchers[d].num_total-o.toBeUsedVouchers[d].num_used,p>h?(i-=h*o.toBeUsedVouchers[d].price,m=o.toBeUsedVouchers[d],m.num_used+=h,l="拟扣"+m.price+"元抵用券"+h+"张",o.leftVouchers.push(m),g=o.toBeUsedVouchers[d],g.num_write_off=h,g.write_off_item=o.parkingCarNum,g.status="USED",o.writeOffVouchers.push(g)):(i-=p*o.toBeUsedVouchers[d].price,b=o.toBeUsedVouchers[d],b.num_used+=p,l="拟扣"+b.price+"元抵用券"+p+"张",b.status="USED",o.endVouchers.push(b),_=o.toBeUsedVouchers[d],_.num_write_off=p,_.write_off_item=o.parkingCarNum,_.status="USED",o.writeOffVouchers.push(_)),c.push(l),console.log(l),0!=i){r.next=46;break}return s=!0,r.abrupt("break",48);case 46:r.next=34;break;case 48:if(console.log("leftVouchers",o.leftVouchers),console.log("writeOffVouchers",o.writeOffVouchers),console.log("endVouchers",o.endVouchers),s){r.next=59;break}return l="还需抵扣金额"+i+"元",c.push(l),console.log(l),e.showToast({icon:"none",title:"消费金额不能完全抵扣"}),o.getList("TO_BE_USE"),o.isLoad=!1,r.abrupt("return");case 59:return r.next=61,wx.cloud.callFunction({name:"vou",data:{$url:"writeOffVoucher",leftVouchers:o.leftVouchers,writeOffVouchers:o.writeOffVouchers,endVouchers:o.endVouchers}});case 61:r.sent,o.tabCur=1,o.getList("USED"),e.showToast({icon:"success",title:"使用成功"}),o.isLoad=!1,setTimeout((function(){o.modalName=null}),1e3);case 67:case"end":return r.stop()}}),r)})))()},showWriteOffModal:function(e){this.modalName=e.currentTarget.dataset.target},hideWriteOffModal:function(e){this.modalName=null}})};t.default=f}).call(this,r(1)["default"])},716:function(e,t,r){"use strict";r.r(t);var n=r(717),o=r.n(n);for(var u in n)"default"!==u&&function(e){r.d(t,e,(function(){return n[e]}))}(u);t["default"]=o.a},717:function(e,t,r){}},[[710,"common/runtime","common/vendor"]]]);
//# sourceMappingURL=../../../.sourcemap/mp-weixin/pagesVoucher/vou-customers/CustomerVoucherList.js.map