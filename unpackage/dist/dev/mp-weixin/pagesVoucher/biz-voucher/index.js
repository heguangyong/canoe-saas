(global["webpackJsonp"]=global["webpackJsonp"]||[]).push([["pagesVoucher/biz-voucher/index"],{702:function(t,e,r){"use strict";(function(t){r(5);n(r(4));var e=n(r(703));function n(t){return t&&t.__esModule?t:{default:t}}wx.__webpack_require_UNI_MP_PLUGIN__=r,t(e.default)}).call(this,r(1)["createPage"])},703:function(t,e,r){"use strict";r.r(e);var n=r(704),i=r(706);for(var a in i)"default"!==a&&function(t){r.d(e,t,(function(){return i[t]}))}(a);r(708);var s,u=r(15),o=Object(u["default"])(i["default"],n["render"],n["staticRenderFns"],!1,null,null,null,!1,n["components"],s);o.options.__file="pagesVoucher/biz-voucher/index.vue",e["default"]=o.exports},704:function(t,e,r){"use strict";r.r(e);var n=r(705);r.d(e,"render",(function(){return n["render"]})),r.d(e,"staticRenderFns",(function(){return n["staticRenderFns"]})),r.d(e,"recyclableRender",(function(){return n["recyclableRender"]})),r.d(e,"components",(function(){return n["components"]}))},705:function(t,e,r){"use strict";var n;r.r(e),r.d(e,"render",(function(){return i})),r.d(e,"staticRenderFns",(function(){return s})),r.d(e,"recyclableRender",(function(){return a})),r.d(e,"components",(function(){return n}));try{n={uniPopup:function(){return r.e("components/uni-popup/uni-popup").then(r.bind(null,810))}}}catch(u){if(-1===u.message.indexOf("Cannot find module")||-1===u.message.indexOf(".vue"))throw u;console.error(u.message),console.error("1. 排查组件名称拼写是否正确"),console.error("2. 排查组件是否符合 easycom 规范，文档：https://uniapp.dcloud.net.cn/collocation/pages?id=easycom"),console.error("3. 若组件不符合 easycom 规范，需手动引入，并在 components 中注册该组件")}var i=function(){var t=this,e=t.$createElement,r=(t._self._c,t.__map(t.actions,(function(e,r){var n=t.__get_orig(e),i=t.checkCardAdminRole(t.user.userInfo.role,e.needRole);return{$orig:n,m0:i}}))),n=0==t.tabCur?t.__map(t.savedActivities,(function(e,r){var n=t.__get_orig(e),i=t.formatCreateAt(e.create_at);return{$orig:n,m1:i}})):null,i=1==t.tabCur?t.__map(t.InProcessActivities,(function(e,r){var n=t.__get_orig(e),i=t.formatCreateAt(e.create_at);return{$orig:n,m2:i}})):null,a=2==t.tabCur?t.__map(t.closeActivities,(function(e,r){var n=t.__get_orig(e),i=t.formatCreateAt(e.create_at);return{$orig:n,m3:i}})):null;t.$mp.data=Object.assign({},{$root:{l0:r,l1:n,l2:i,l3:a}})},a=!1,s=[];i._withStripped=!0},706:function(t,e,r){"use strict";r.r(e);var n=r(707),i=r.n(n);for(var a in n)"default"!==a&&function(t){r.d(e,t,(function(){return n[t]}))}(a);e["default"]=i.a},707:function(t,e,r){"use strict";(function(t){Object.defineProperty(e,"__esModule",{value:!0}),e.default=void 0;var n=s(r(9)),i=r(12),a=s(r(39));function s(t){return t&&t.__esModule?t:{default:t}}function u(t,e,r,n,i,a,s){try{var u=t[a](s),o=u.value}catch(c){return void r(c)}u.done?e(o):Promise.resolve(o).then(n,i)}function o(t){return function(){var e=this,r=arguments;return new Promise((function(n,i){var a=t.apply(e,r);function s(t){u(a,n,i,s,o,"next",t)}function o(t){u(a,n,i,s,o,"throw",t)}s(void 0)}))}}function c(t,e){var r=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),r.push.apply(r,n)}return r}function d(t){for(var e=1;e<arguments.length;e++){var r=null!=arguments[e]?arguments[e]:{};e%2?c(Object(r),!0).forEach((function(e){l(t,e,r[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(r)):c(Object(r)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(r,e))}))}return t}function l(t,e,r){return e in t?Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}):t[e]=r,t}var p=function(){r.e("components/uni-popup/uni-popup").then(function(){return resolve(r(810))}.bind(null,r)).catch(r.oe)},f={components:{"uni-popup":p},data:function(){return{CustomBar:this.CustomBar,isLoad:!1,actions:[{title:"制券",name:"ticket",url:"/pagesVoucher/biz-voucher/VoucherTypeList",isShow:!0,needRole:"cardAdmin"},{title:"核销",name:"qrcode",url:"/pagesVoucher/vou-entries/index",isShow:!0,needRole:""},{title:"用户",name:"people",url:"/pagesVoucher/vou-customers/index",isShow:!0,needRole:"cardAdmin"},{title:"员工",name:"profile",url:"/pagesVoucher/vou-members/index",isShow:!0,needRole:"cardAdmin"},{title:"统计",name:"rank",url:"",isShow:!0,needRole:"cardAdmin"}],tabCur:0,tab:["未发布","进行中","已结束"],currentActivity:{},savedActivities:[],InProcessActivities:[],closeActivities:[],page:1,isEndPage:!1,loadingType:1,isUps:!1,itemSelectedId:"-1",listGroup:{},partyList:[{}],index:-1,subList:[],search_str:""}},onLoad:function(t){var e=this;e.tabCur=1},onShow:function(){1==this.tabCur&&this.getList("IN_PROCESS")},onPullDownRefresh:function(){this.page=1,0===this.tabCur?this.getList("SAVED"):1===this.tabCur?this.getList("IN_PROCESS"):2===this.tabCur&&this.getList("CLOSE"),t.stopPullDownRefresh()},onReachBottom:function(){this.page++,0===this.tabCur?this.getList("SAVED"):1===this.tabCur?this.getList("IN_PROCESS"):2===this.tabCur&&this.getList("CLOSE")},computed:d(d({},(0,i.mapState)(["user"])),{},{checkCardAdminRole:function(){return function(t,e){var r=t||"";return r.indexOf(e)>-1}},formatCreateAt:function(){return function(t){var e=t;return e?a.default.formatTime(e,"yyyy-MM-dd HH:mm:ss"):""}}}),methods:{go:function(e){0==e.url.length&&t.showToast({icon:"none",title:e.title+"暂未开放！"}),console.log("go url",e.url+"?cardId="+this.user.userInfo.bizCardId+"&cardName="+this.user.userInfo.bizCardName),t.navigateTo({url:e.url+"?cardId="+this.user.userInfo.bizCardId+"&cardName="+this.user.userInfo.bizCardName})},tabSelect:function(t){this.tabCur=t.currentTarget.dataset.id,0===this.tabCur?this.getList("SAVED"):1===this.tabCur?this.getList("IN_PROCESS"):2===this.tabCur&&this.getList("CLOSE")},getList:function(t){var e=this;return o(n.default.mark((function r(){var i,a,s;return n.default.wrap((function(r){while(1)switch(r.prev=r.next){case 0:if(i=e,!(i.user.userInfo.role.indexOf("cardAdmin")<0)){r.next=3;break}return r.abrupt("return");case 3:return e.isLoad=!0,i.loadingType=1,r.next=7,wx.cloud.callFunction({name:"vou",data:{$url:"getActivityList",cardId:i.user.userInfo.bizCardId,userId:i.user._id,page:i.page,status:t}});case 7:a=r.sent,console.log("getList bizcardId",i.user.userInfo.bizCardId,"userId",i.user._id,t,a.result),s=a.result,0==s.code&&(1==i.page&&(i.isEndPage=!1,0===i.tabCur?i.savedActivities=[]:1===i.tabCur?i.InProcessActivities=[]:2===i.tabCur&&(i.closeActivities=[])),s.data.forEach((function(t){0===i.tabCur?i.savedActivities.push(t):1===i.tabCur?i.InProcessActivities.push(t):2===i.tabCur&&i.closeActivities.push(t)}))),s.data.length<10&&(i.isEndPage=!0,i.loadingType=2),i.isLoad=!1;case 13:case"end":return r.stop()}}),r)})))()},popupOperate:function(t){var e=this;console.log("popupOperate",t),e.itemSelectedId=t._id,e.currentActivity=t,this.$nextTick((function(){e.$refs["showPopupOperate"].open()}))},change:function(t){t.show?this.isUps=!0:this.isUps=!1},cancel:function(t){this.$refs["show"+t].close()},goInProcess:function(){var e=this;return o(n.default.mark((function r(){var i,a;return n.default.wrap((function(r){while(1)switch(r.prev=r.next){case 0:return i=e,i.currentActivity.status="IN_PROCESS",console.log("goInProcess",i.currentActivity),r.next=5,wx.cloud.callFunction({name:"vou",data:{$url:"saveActivity",activity:i.currentActivity}});case 5:a=r.sent,i.tabCur=1,i.getList("IN_PROCESS"),i.$refs["showPopupOperate"].close(),0==a.result.code&&t.showToast({icon:"success",title:"发布成功"});case 10:case"end":return r.stop()}}),r)})))()},goDetail:function(e){console.log("goDetail",e),this.currentActivity._id?this.itemSelectedId=this.currentActivity._id:this.itemSelectedId=e._id,t.navigateTo({url:"/pagesVoucher/biz-voucher/ActivityDetail?id="+this.itemSelectedId}),this.$refs["showPopupOperate"].close()},goEdit:function(){console.log("goEdit",this.itemSelectedId),t.navigateTo({url:"/pagesVoucher/biz-voucher/ActivityInput?id="+this.itemSelectedId}),this.$refs["showPopupOperate"].close()},remove:function(){var e=this;return o(n.default.mark((function r(){var i;return n.default.wrap((function(r){while(1)switch(r.prev=r.next){case 0:return i=e,console.log("go remove activity",i.itemSelectedId),r.next=4,wx.cloud.callFunction({name:"vou-activities",data:{$url:"remove",id:i.itemSelectedId}});case 4:i.$refs["showPopupOperate"].close(),t.showToast({icon:"success",title:"删除成功"}),i.page=1,0===i.tabCur?i.getList("SAVED"):1===i.tabCur?i.getList("IN_PROCESS"):2===i.tabCur&&i.getList("CLOSE"),t.stopPullDownRefresh(),i.$forceUpdate();case 10:case"end":return r.stop()}}),r)})))()},goMyHome:function(){t.reLaunch({url:"/pages/my/home"})},goMyCard:function(){t.navigateTo({url:"/pagesSys/card/CardDetail"})},goProduct:function(){t.reLaunch({url:"/pages/site/product"})},getPartyList:function(){var t=this;return o(n.default.mark((function e(){var r,i,a;return n.default.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return r=t,r.partyList=[],r.isLoad=!0,e.next=5,wx.cloud.callFunction({name:"sys",data:{$url:"getCardHolderByCardId",cardId:r.user.userInfo.bizCardId}});case 5:i=e.sent,a=i.result,0==a.code&&a.data&&function(){r.listGroup=a.data.cards||{};var t=0,e=r.search_str.length>0,n=function(n){r.listGroup[n].length>0&&r.listGroup[n].forEach((function(i){var a=i.search_str||"";e?a.indexOf(r.search_str)>-1&&(r.partyList[t]={},r.partyList[t].group=n,r.partyList[t].subList=r.listGroup[n],t++):(r.partyList[t]={},r.partyList[t].group=n,r.partyList[t].subList=r.listGroup[n],t++)}))};for(var i in r.listGroup)n(i)}(),r.isLoad=!1,r.$forceUpdate();case 10:case"end":return e.stop()}}),e)})))()},openSendVoucher:function(){var t=this;t.$refs["showPopupOperate"].close(),t.getPartyList(),t.$nextTick((function(){t.$refs["showPartyCard"].open()}))},sendVoucher:function(e,r,i,a){var s=this;return o(n.default.mark((function u(){var o,c,d;return n.default.wrap((function(n){while(1)switch(n.prev=n.next){case 0:if(o=s,o.isLoad=!0,!(parseInt(o.currentActivity.num_used)+parseInt(i)>parseInt(o.currentActivity.num_total))){n.next=5;break}return t.showToast({icon:"none",title:"剩余券数不足，无法发券"}),n.abrupt("return");case 5:return console.log("current hold card",o.partyList[e].subList[r]),c={activity_id:o.currentActivity._id,activity_name:o.currentActivity.name,entry_id:o.currentActivity.entry_id,entry_name:o.currentActivity.entry_name,bg_color:o.currentActivity.bg_color,icon:o.currentActivity.icon,valid_date:o.currentActivity.valid_date,card_id:o.currentActivity.card_id,card_name:o.currentActivity.card_name,card_avatar:o.currentActivity.avatar,user_id:o.partyList[e].subList[r].user_id,user_name:o.partyList[e].subList[r].name,user_avatar:o.partyList[e].subList[r].avatar,managed_user_id:o.user.userInfo._id,managed_user_name:o.user.userInfo.name,managed_user_avatar:o.user.userInfo.avatar,managed_status:"RECEIVED",managed_status_name:"已领取",num_total:parseInt(i),num_used:0,price:parseFloat(o.currentActivity.price),status:"TO_BE_USE",type_code:o.currentActivity.type_code,type_name:o.currentActivity.type_name,cover:o.currentActivity.cover,remark:a},n.next=9,wx.cloud.callFunction({name:"vou",data:{$url:"saveVoucher",voucher:c}});case 9:return d=n.sent,console.log("sendVoucher",c,d),o.currentActivity.num_used=parseInt(o.currentActivity.num_used)+parseInt(i),o.leftNum=parseInt(o.currentActivity.num_total)-parseInt(o.currentActivity.num_used),console.log("currentActivity",o.currentActivity.num_total,o.currentActivity.num_used,o.leftNum),0==o.leftNum&&(o.currentActivity.status="CLOSE"),n.next=17,wx.cloud.callFunction({name:"vou",data:{$url:"saveActivity",activity:o.currentActivity}});case 17:d=n.sent,console.log("save activity",d),0==d.result.code&&(o.partyList[e].subList[r].num_total=parseInt(i),o.partyList[e].subList[r].send_success=!0,o.isLoad=!1,o.$forceUpdate(),t.showToast({icon:"success",title:"发券成功"}),setTimeout((function(){o.tabCur=1,o.getList("IN_PROCESS")}),3e3));case 20:case"end":return n.stop()}}),u)})))()},inputFocus:function(t){console.log(t)},inputBlur:function(t){console.log(t),this.partyList=[],this.search_str=t.detail.value,this.page=1}}};e.default=f}).call(this,r(1)["default"])},708:function(t,e,r){"use strict";r.r(e);var n=r(709),i=r.n(n);for(var a in n)"default"!==a&&function(t){r.d(e,t,(function(){return n[t]}))}(a);e["default"]=i.a},709:function(t,e,r){}},[[702,"common/runtime","common/vendor"]]]);
//# sourceMappingURL=../../../.sourcemap/mp-weixin/pagesVoucher/biz-voucher/index.js.map