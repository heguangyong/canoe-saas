(global["webpackJsonp"]=global["webpackJsonp"]||[]).push([["pagesSys/site/service"],{263:function(t,e,r){"use strict";(function(t){r(5);a(r(4));var e=a(r(264));function a(t){return t&&t.__esModule?t:{default:t}}wx.__webpack_require_UNI_MP_PLUGIN__=r,t(e.default)}).call(this,r(1)["createPage"])},264:function(t,e,r){"use strict";r.r(e);var a=r(265),o=r(267);for(var n in o)"default"!==n&&function(t){r.d(e,t,(function(){return o[t]}))}(n);r(269);var c,u=r(15),s=Object(u["default"])(o["default"],a["render"],a["staticRenderFns"],!1,null,null,null,!1,a["components"],c);s.options.__file="pagesSys/site/service.vue",e["default"]=s.exports},265:function(t,e,r){"use strict";r.r(e);var a=r(266);r.d(e,"render",(function(){return a["render"]})),r.d(e,"staticRenderFns",(function(){return a["staticRenderFns"]})),r.d(e,"recyclableRender",(function(){return a["recyclableRender"]})),r.d(e,"components",(function(){return a["components"]}))},266:function(t,e,r){"use strict";var a;r.r(e),r.d(e,"render",(function(){return o})),r.d(e,"staticRenderFns",(function(){return c})),r.d(e,"recyclableRender",(function(){return n})),r.d(e,"components",(function(){return a}));var o=function(){var t=this,e=t.$createElement,r=(t._self._c,t.__map(t.historyTalk,(function(e,r){var a=t.__get_orig(e),o=t.getDateDiff(e.create_at);return{$orig:a,m0:o}}))),a=t.__map(t.talk,(function(e,r){var a=t.__get_orig(e),o=t.getDateDiff(e.create_at);return{$orig:a,m1:o}}));t.$mp.data=Object.assign({},{$root:{l0:r,l1:a}})},n=!1,c=[];o._withStripped=!0},267:function(t,e,r){"use strict";r.r(e);var a=r(268),o=r.n(a);for(var n in a)"default"!==n&&function(t){r.d(e,t,(function(){return a[t]}))}(n);e["default"]=o.a},268:function(t,e,r){"use strict";(function(t){Object.defineProperty(e,"__esModule",{value:!0}),e.default=void 0;var a=n(r(9)),o=r(12);function n(t){return t&&t.__esModule?t:{default:t}}function c(t,e,r,a,o,n,c){try{var u=t[n](c),s=u.value}catch(d){return void r(d)}u.done?e(s):Promise.resolve(s).then(a,o)}function u(t){return function(){var e=this,r=arguments;return new Promise((function(a,o){var n=t.apply(e,r);function u(t){c(n,a,o,u,s,"next",t)}function s(t){c(n,a,o,u,s,"throw",t)}u(void 0)}))}}function s(t,e){var r=Object.keys(t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(t);e&&(a=a.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),r.push.apply(r,a)}return r}function d(t){for(var e=1;e<arguments.length;e++){var r=null!=arguments[e]?arguments[e]:{};e%2?s(Object(r),!0).forEach((function(e){i(t,e,r[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(r)):s(Object(r)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(r,e))}))}return t}function i(t,e,r){return e in t?Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}):t[e]=r,t}var l={data:function(){return{sourceCardId:"",targetCardId:"",talkWatch:null,roomId:"",chatRoom:{},content:"",source:{},target:{},talk:[],historyTalk:[],hasHistory:!0,page:1}},onLoad:function(t){var e=this;e.sourceCardId=e.user.userInfo.cardId,t.sourceCardId&&(e.sourceCardId=t.sourceCardId),e.targetCardId=e.user.userInfo.bizCardId,t.targetCardId&&(e.targetCardId=t.targetCardId)},onShow:function(){this.watchChatRoom()},onHide:function(){var t=this;this.talkWatch&&this.talkWatch.close().then((function(){t.talkWatch=null}))},onPageScroll:function(t){t.scrollTop<5&&this.hasHistory&&(this.page++,this.loadHistory())},computed:d({},(0,o.mapState)(["user"])),methods:{watchChatRoom:function(){var e=this;return u(a.default.mark((function r(){var o,n,c,u,s,d,i;return a.default.wrap((function(r){while(1)switch(r.prev=r.next){case 0:return o=e,r.next=3,wx.cloud.callFunction({name:"sys",data:{$url:"getCardDetailById",id:o.sourceCardId}});case 3:return n=r.sent,c=n.result.data,r.next=7,wx.cloud.callFunction({name:"sys",data:{$url:"getCardDetailById",id:o.targetCardId}});case 7:return n=r.sent,u=n.result.data,r.next=11,wx.cloud.callFunction({name:"sys",data:{$url:"getChatRoom",sourceId:o.sourceCardId,targetId:o.targetCardId}});case 11:if(n=r.sent,-1!=n.result.code){r.next=21;break}return o.chatRoom={target_id:u._id,target_name:u.name,target_avatar:u.avatar,source_id:c._id,source_name:c.name,source_avatar:c.avatar,content:[],target_unread:0,source_unread:0,last_history:""},r.next=16,wx.cloud.callFunction({name:"sys",data:{$url:"addChatRoom",chatRoom:o.chatRoom}});case 16:s=r.sent,o.roomId=s.result.data,o.chatRoom._id=o.roomId,r.next=22;break;case 21:0==n.result.code&&(o.chatRoom=n.result.data,o.roomId=o.chatRoom._id);case 22:return r.next=24,wx.cloud.callFunction({name:"sys",data:{$url:"exchangeCards",roomId:o.roomId,askCardId:o.sourceCardId,answerCardId:o.targetCardId}});case 24:return n=r.sent,console.log("交换名片",n),d=o.chatRoom.source_id==o.sourceCardId,o.source.sourceId=d?o.chatRoom.source_id:o.chatRoom.target_id,o.source.sourceName=d?o.chatRoom.source_name:o.chatRoom.target_name,o.source.sourceAvatar=d?o.chatRoom.source_avatar:o.chatRoom.target_avatar,o.target.targetId=d?o.chatRoom.target_id:o.chatRoom.source_id,o.target.targetName=d?o.chatRoom.target_name:o.chatRoom.source_name,o.target.targetAvatar=d?o.chatRoom.target_avatar:o.chatRoom.source_avatar,console.log("加载聊天室：","roomId",o.roomId,"sourceName",o.source.sourceName,"targetName",o.target.targetName,"isSource",d),r.next=36,wx.cloud.callFunction({name:"sys",data:{$url:"clearUnreadChatTip",id:o.roomId,isSource:d}});case 36:i=wx.cloud.database(),o.talkWatch=i.collection("sys_chat_msg").where({room_id:o.roomId}).watch({onChange:function(e){"init"===e.type?wx.cloud.callFunction({name:"sys",data:{$url:"getChatMsgHistoryList",id:o.roomId,page:o.page}}).then((function(e){o.historyTalk=e.result.data,o.historyTalk=o.historyTalk.reverse(),t.pageScrollTo({scrollTop:9999999,duration:0})})):"add"==e.docChanges[0].dataType&&(o.talk.push(e.docChanges[0].doc),t.pageScrollTo({scrollTop:9999999,duration:0}))},onError:function(t){console.log("the watch closed because of error",t)}});case 38:case"end":return r.stop()}}),r)})))()},loadHistory:function(){var t=this;return u(a.default.mark((function e(){var r,o,n,c;return a.default.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return r=t,e.next=3,wx.cloud.callFunction({name:"sys",data:{$url:"getChatMsgHistoryList",id:r.roomId,page:r.page}});case 3:if(o=e.sent,0==o.result.code)for(n=o.result.data,c=0;c<n.length;c++)r.historyTalk.unshift(n[c]);else r.hasHistory=!1;case 5:case"end":return e.stop()}}),e)})))()},inputContent:function(t){this.content=t.detail.value},send:function(){var e=this;return u(a.default.mark((function r(){var o,n,c,u,s,d;return a.default.wrap((function(r){while(1)switch(r.prev=r.next){case 0:if(o=e,""==o.content){r.next=24;break}return r.next=4,wx.cloud.callFunction({name:"sys",data:{$url:"msgSecCheck",value:o.content}});case 4:if(n=r.sent,0==n.result.code){r.next=8;break}return t.showToast({icon:"none",title:"内容含有违规内容，请修改后提交"}),r.abrupt("return");case 8:return c={},c={content:e.content,source:o.source.sourceId,target:o.target.targetId,type:"text",room_id:o.roomId},r.next=12,wx.cloud.callFunction({name:"sys",data:{$url:"addTalk",talk:c}});case 12:if(u=r.sent,0!=u.result.code){r.next=21;break}return s="",d=!1,s=e.content,d=o.chatRoom.source_id==o.sourceCardId,r.next=20,wx.cloud.callFunction({name:"sys",data:{$url:"updateChatRoomUnreadTip",id:o.roomId,tid:u.result.data,last_history:s,isSource:d}});case 20:r.sent;case 21:o.content="",t.pageScrollTo({scrollTop:9999999,duration:0}),e.$forceUpdate();case 24:case"end":return r.stop()}}),r)})))()},getDateDiff:function(t){var e="",r=Date.parse(new Date),a=Math.abs(r-t);if(a>6048e5){e=new Date(t);var o=e.getFullYear(),n=e.getMonth()+1,c=e.getDate(),u=(new Date).getFullYear();e=u==o?n+"月"+c+"日":o+"年"+n+"月"+c+"日"}else if(a<6048e5&&a>864e5){var s=Math.floor(a/864e5);e=s+"天前"}else if(a<864e5&&a>36e5){s=Math.floor(a/36e5);e=s+"小时前"}else a<36e5&&a>=0&&(e="");return e}}};e.default=l}).call(this,r(1)["default"])},269:function(t,e,r){"use strict";r.r(e);var a=r(270),o=r.n(a);for(var n in a)"default"!==n&&function(t){r.d(e,t,(function(){return a[t]}))}(n);e["default"]=o.a},270:function(t,e,r){}},[[263,"common/runtime","common/vendor"]]]);
//# sourceMappingURL=../../../.sourcemap/mp-weixin/pagesSys/site/service.js.map