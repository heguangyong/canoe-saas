(global["webpackJsonp"]=global["webpackJsonp"]||[]).push([["pagesSys/site/WebService"],{271:function(t,e,r){"use strict";(function(t){r(5);a(r(4));var e=a(r(272));function a(t){return t&&t.__esModule?t:{default:t}}wx.__webpack_require_UNI_MP_PLUGIN__=r,t(e.default)}).call(this,r(1)["createPage"])},272:function(t,e,r){"use strict";r.r(e);var a=r(273),n=r(275);for(var o in n)"default"!==o&&function(t){r.d(e,t,(function(){return n[t]}))}(o);r(382);var c,u=r(15),s=Object(u["default"])(n["default"],a["render"],a["staticRenderFns"],!1,null,null,null,!1,a["components"],c);s.options.__file="pagesSys/site/WebService.vue",e["default"]=s.exports},273:function(t,e,r){"use strict";r.r(e);var a=r(274);r.d(e,"render",(function(){return a["render"]})),r.d(e,"staticRenderFns",(function(){return a["staticRenderFns"]})),r.d(e,"recyclableRender",(function(){return a["recyclableRender"]})),r.d(e,"components",(function(){return a["components"]}))},274:function(t,e,r){"use strict";var a;r.r(e),r.d(e,"render",(function(){return n})),r.d(e,"staticRenderFns",(function(){return c})),r.d(e,"recyclableRender",(function(){return o})),r.d(e,"components",(function(){return a}));var n=function(){var t=this,e=t.$createElement,r=(t._self._c,t.__map(t.historyTalk,(function(e,r){var a=t.__get_orig(e),n=t.getDateDiff(e.create_at);return{$orig:a,m0:n}}))),a=t.__map(t.talk,(function(e,r){var a=t.__get_orig(e),n=t.getDateDiff(e.create_at);return{$orig:a,m1:n}}));t.$mp.data=Object.assign({},{$root:{l0:r,l1:a}})},o=!1,c=[];n._withStripped=!0},275:function(t,e,r){"use strict";r.r(e);var a=r(276),n=r.n(a);for(var o in a)"default"!==o&&function(t){r.d(e,t,(function(){return a[t]}))}(o);e["default"]=n.a},276:function(t,e,r){"use strict";(function(t){Object.defineProperty(e,"__esModule",{value:!0}),e.default=void 0;var a=c(r(9)),n=r(12),o=c(r(277));function c(t){return t&&t.__esModule?t:{default:t}}function u(t,e,r,a,n,o,c){try{var u=t[o](c),s=u.value}catch(i){return void r(i)}u.done?e(s):Promise.resolve(s).then(a,n)}function s(t){return function(){var e=this,r=arguments;return new Promise((function(a,n){var o=t.apply(e,r);function c(t){u(o,a,n,c,s,"next",t)}function s(t){u(o,a,n,c,s,"throw",t)}c(void 0)}))}}function i(t,e){var r=Object.keys(t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(t);e&&(a=a.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),r.push.apply(r,a)}return r}function d(t){for(var e=1;e<arguments.length;e++){var r=null!=arguments[e]?arguments[e]:{};e%2?i(Object(r),!0).forEach((function(e){l(t,e,r[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(r)):i(Object(r)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(r,e))}))}return t}function l(t,e,r){return e in t?Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}):t[e]=r,t}var f={data:function(){return{sourceCardId:"",targetCardId:"",talkWatch:null,roomId:"",chatRoom:{},content:"",source:{},target:{},talk:[],historyTalk:[],hasHistory:!0,lastHistory:{_id:0,content:"",send_time:""},page:1,timer:null}},onLoad:function(t){var e=this;e.sourceCardId=e.user.userInfo.cardId,t.sourceCardId&&(e.sourceCardId=t.sourceCardId),e.targetCardId=e.user.userInfo.bizCardId,t.targetCardId&&(e.targetCardId=t.targetCardId)},mounted:function(){this.timer=setInterval(this.loadNewMsgList,6e3)},beforeDestroy:function(){clearInterval(this.timer)},onShow:function(){this.watchChatRoom()},onHide:function(){var t=this;this.talkWatch&&this.talkWatch.close().then((function(){t.talkWatch=null}))},onPageScroll:function(t){t.scrollTop<5&&this.hasHistory&&(this.page++,this.loadHistory())},computed:d({},(0,n.mapState)(["user"])),methods:{watchChatRoom:function(){var e=this;return s(a.default.mark((function r(){var n,c,u,s,i,d;return a.default.wrap((function(r){while(1)switch(r.prev=r.next){case 0:return n=e,c={},u={},s=null,r.next=6,o.default.callFunction({name:"web",data:{$url:"getCardDetailById",id:n.sourceCardId}});case 6:return s=r.sent,c=JSON.parse(s.result.data),r.next=10,o.default.callFunction({name:"web",data:{$url:"getCardDetailById",id:n.targetCardId}});case 10:return s=r.sent,u=JSON.parse(s.result.data),r.next=14,o.default.callFunction({name:"web",data:{$url:"getChatRoom",sourceId:n.sourceCardId,targetId:n.targetCardId}});case 14:if(s=r.sent,-1!=s.result.code){r.next=25;break}return n.chatRoom={target_id:u._id,target_name:u.name,target_avatar:u.avatar,source_id:c._id,source_name:c.name,source_avatar:c.avatar,content:[],target_unread:0,source_unread:0,last_history:""},i=null,r.next=20,o.default.callFunction({name:"sys",data:{$url:"addChatRoom",chatRoom:n.chatRoom}});case 20:i=r.sent,n.roomId=i.result.data,n.chatRoom._id=n.roomId,r.next=26;break;case 25:0==s.result.code&&(n.chatRoom=JSON.parse(s.result.data),n.roomId=n.chatRoom._id);case 26:return r.next=28,o.default.callFunction({name:"sys",data:{$url:"exchangeCards",roomId:n.roomId,askCardId:n.sourceCardId,answerCardId:n.targetCardId}});case 28:return s=r.sent,d=n.chatRoom.source_id==n.sourceCardId,n.source.sourceId=d?n.chatRoom.source_id:n.chatRoom.target_id,n.source.sourceName=d?n.chatRoom.source_name:n.chatRoom.target_name,n.source.sourceAvatar=d?n.chatRoom.source_avatar:n.chatRoom.target_avatar,n.target.targetId=d?n.chatRoom.target_id:n.chatRoom.source_id,n.target.targetName=d?n.chatRoom.target_name:n.chatRoom.source_name,n.target.targetAvatar=d?n.chatRoom.target_avatar:n.chatRoom.source_avatar,r.next=38,o.default.callFunction({name:"sys",data:{$url:"clearUnreadChatTip",id:n.roomId,isSource:d}});case 38:n.loadHistory(),n.historyTalk=n.historyTalk.reverse(),t.pageScrollTo({scrollTop:9999999,duration:0});case 41:case"end":return r.stop()}}),r)})))()},loadHistory:function(){var t=this;return s(a.default.mark((function e(){var r,n,c,u;return a.default.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return r=t,e.next=3,o.default.callFunction({name:"web",data:{$url:"getChatMsgHistoryList",id:r.roomId,page:r.page}});case 3:if(n=e.sent,0==n.result.code)for(c=null,c=JSON.parse(n.result.data),u=0;u<c.length;u++)r.historyTalk.unshift(c[u]);else r.hasHistory=!1;case 5:case"end":return e.stop()}}),e)})))()},loadNewMsgList:function(){var e=this;return s(a.default.mark((function r(){var n,c,u;return a.default.wrap((function(r){while(1)switch(r.prev=r.next){case 0:return n=e,n.lastHistory=n.historyTalk[n.historyTalk.length-1]||{_id:0,content:"",send_time:""},r.next=4,o.default.callFunction({name:"web",data:{$url:"getNewChatMsgList",id:n.roomId,create_at:n.lastHistory.create_at}});case 4:c=r.sent,0==c.result.code&&(u=JSON.parse(c.result.data),Object.assign(n.talk,u),t.pageScrollTo({scrollTop:9999999,duration:0}),n.$forceUpdate());case 6:case"end":return r.stop()}}),r)})))()},inputContent:function(t){this.content=t.detail.value},send:function(){var e=this;return s(a.default.mark((function r(){var n,c,u,s,i;return a.default.wrap((function(r){while(1)switch(r.prev=r.next){case 0:if(n=e,""==n.content){r.next=20;break}return c={},c={content:e.content,source:n.source.sourceId,target:n.target.targetId,type:"text",room_id:n.roomId},u=null,r.next=7,o.default.callFunction({name:"sys",data:{$url:"addTalk",talk:c}});case 7:if(u=r.sent,0!=u.result.code){r.next=17;break}return s="",i=!1,s=e.content,i=n.chatRoom.source_id==n.sourceCardId,null,r.next=16,o.default.callFunction({name:"sys",data:{$url:"updateChatRoomUnreadTip",id:n.roomId,tid:u.result.data,last_history:s,isSource:i}});case 16:r.sent;case 17:n.content="",t.pageScrollTo({scrollTop:999999,duration:0}),e.$forceUpdate();case 20:case"end":return r.stop()}}),r)})))()},getDateDiff:function(t){var e="",r=Date.parse(new Date),a=Math.abs(r-t);if(a>6048e5){e=new Date(t);var n=e.getFullYear(),o=e.getMonth()+1,c=e.getDate(),u=(new Date).getFullYear();e=u==n?o+"月"+c+"日":n+"年"+o+"月"+c+"日"}else if(a<6048e5&&a>864e5){var s=Math.floor(a/864e5);e=s+"天前"}else if(a<864e5&&a>36e5){s=Math.floor(a/36e5);e=s+"小时前"}else a<36e5&&a>=0&&(e="");return e}}};e.default=f}).call(this,r(1)["default"])},382:function(t,e,r){"use strict";r.r(e);var a=r(383),n=r.n(a);for(var o in a)"default"!==o&&function(t){r.d(e,t,(function(){return a[t]}))}(o);e["default"]=n.a},383:function(t,e,r){}},[[271,"common/runtime","common/vendor"]]]);
//# sourceMappingURL=../../../.sourcemap/mp-weixin/pagesSys/site/WebService.js.map